<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>UIWebView的加载进度条 | 夜满西楼的博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">UIWebView的加载进度条</h1><a id="logo" href="/.">夜满西楼的博客</a><p class="description">运气就是机会碰巧撞到了你的努力。</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">UIWebView的加载进度条</h1><div class="post-meta">Mar 17, 2017<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a class="disqus-comment-count" data-disqus-identifier="2017/03/17/UIWebView的加载进度条/" href="/2017/03/17/UIWebView的加载进度条/#disqus_thread"></a><div class="post-content"><h3 id="导语"><a href="#导语" class="headerlink" title="导语"></a>导语</h3><p>在一个阳光明媚的午后，组织终于决定把公司的SDK产品，由Native更换成H5，你没看错，就是用Native界面做的SDK，说多了都是眼泪。产品说，网页加载的时候要有进度条，OK，没问题，一个字就是<strong>“干”</strong>，你懂的。</p>
<blockquote>
<p>现在的iOS 应用中，或多或少都会有H5页，因为H5有Native所不具备的灵活性，比如应用中的活动展示，需要不定时的更新，使用H5来做就能轻松搞定！iOS中常用的H5容器有两种：<em>1、 UIWebView 2、WKWebView。</em></p>
<ul>
<li><strong>WKWebView</strong> 是<strong>iOS8.0</strong>以后开放的API，可以通过KVO来监听<code>estimatedProgress</code>属性的变化来获取当前网页的加载进度，如果你的项目不用适配iOS6、iOS7<em>（太爽了，幸福感爆棚有木有），</em>那么你可以很easy的做一个WebView的进度条。</li>
<li><strong>UIWebView</strong> 如果你的应用需要适配iOS7、或者iOS6 或者更早😂。UIWebView是你不二的<em>（也是唯一的）</em>选择，查看系统的API后并没有发现可以获取加载进度的途径，so…你看到的网页有加载进度，如果它是用UIWebView加载的，那进度条一定是 <strong>假的！ 假的！假的！😁</strong></li>
</ul>
</blockquote>
<p>应商户要求，SDK最低需要支持iOS6.0，然而组织并没有6.0系统的测试机，领导决定，把SDK最低支持的系统为设为6.0，虽然没有真机试过，到底能不能在6.0系统上使用也未知，鉴于这些，H5只能通过UIWebView来加载了。</p>
<p>####废话不多说，先来个成品的效果图：</p>
<h5 id="效果1"><a href="#效果1" class="headerlink" title="效果1 "></a>效果1 <img src="http://upload-images.jianshu.io/upload_images/1890873-e45931be0265dd9b.gif?imageMogr2/auto-orient/strip" alt="图片1"></h5><h5 id="效果2"><a href="#效果2" class="headerlink" title="效果2"></a>效果2<img src="http://upload-images.jianshu.io/upload_images/1890873-8a38ca6ae4a898fb.gif?imageMogr2/auto-orient/strip" alt="图片2"></h5><p><a href="https://github.com/jindk/WebViewProgress" target="_blank" rel="noopener">Demo下载链接</a></p>
<h4 id="1、第一次尝试"><a href="#1、第一次尝试" class="headerlink" title="1、第一次尝试"></a>1、第一次尝试</h4><p>进度条嘛，第一反应就是用系统的<code>UIProgressView</code>，然而试过之后才发现系统的<code>UIProgressView</code>限制太多，可以自定义的太少了，所以就放弃了。</p>
<h4 id="2、第二次尝试"><a href="#2、第二次尝试" class="headerlink" title="2、第二次尝试"></a>2、第二次尝试</h4><p>百度、Google一番，好多道友都建议使用CAShapeLayer来做，好吧，<strong>干！</strong><br>查看系统CAShapeLayer的API发现，CAShapeLayer有两个属性<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/* These values define <span class="keyword">the</span> subregion <span class="keyword">of</span> <span class="keyword">the</span> path used <span class="keyword">to</span> draw <span class="keyword">the</span></span><br><span class="line"> * stroked outline. The values must be <span class="keyword">in</span> <span class="keyword">the</span> range [<span class="number">0</span>,<span class="number">1</span>] <span class="keyword">with</span> zero</span><br><span class="line"> * representing <span class="keyword">the</span> start <span class="keyword">of</span> <span class="keyword">the</span> path <span class="keyword">and</span> one <span class="keyword">the</span> <span class="keyword">end</span>. Values <span class="keyword">in</span></span><br><span class="line"> * <span class="keyword">between</span> zero <span class="keyword">and</span> one are interpolated linearly along <span class="keyword">the</span> path</span><br><span class="line"> * <span class="built_in">length</span>. strokeStart defaults <span class="keyword">to</span> zero <span class="keyword">and</span> strokeEnd <span class="keyword">to</span> one. Both are</span><br><span class="line"> * animatable. */</span><br><span class="line">@<span class="keyword">property</span> CGFloat strokeStart;</span><br><span class="line">@<span class="keyword">property</span> CGFloat strokeEnd;</span><br></pre></td></tr></table></figure></p>
<p>意思就是CAShapeLayer的设置这两个描边的起始和结束位置是有<strong>动画效果</strong>的<br>自定一个类DKProgressLayer继承自CAShapeLayer</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#define DEVICE_WIDTH [UIScreen mainScreen].bounds.size.width</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">DKProgressLayer</span> : <span class="title">CAShapeLayer</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">UIColor</span> *progressColor;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 进度条开始加载</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)progressAnimationStart;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> 进度条加载完成</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">- (<span class="keyword">void</span>)progressAnimationCompletion;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">DKProgressLayer</span> ()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSTimer</span> *timer;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">CGFloat</span> stepWidth;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="built_in">NSTimeInterval</span> <span class="keyword">const</span> progressInterval = <span class="number">0.01</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">DKProgressLayer</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)init &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span> = [<span class="keyword">super</span> init]) &#123;</span><br><span class="line">        <span class="keyword">self</span>.progressColor = [<span class="built_in">UIColor</span> whiteColor];</span><br><span class="line">        <span class="keyword">self</span>.stepWidth = <span class="number">0.01</span>;</span><br><span class="line">        <span class="keyword">self</span>.lineWidth = <span class="number">2</span>;</span><br><span class="line">        <span class="built_in">UIBezierPath</span> *path = [<span class="built_in">UIBezierPath</span> bezierPath];</span><br><span class="line">        [path moveToPoint:<span class="built_in">CGPointMake</span>(<span class="number">0</span>, <span class="number">2</span>)];</span><br><span class="line">        [path addLineToPoint:<span class="built_in">CGPointMake</span>(DEVICE_WIDTH, <span class="number">2</span>)];</span><br><span class="line">        <span class="keyword">self</span>.path = path.CGPath;</span><br><span class="line">        <span class="keyword">self</span>.strokeEnd = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setProgressColor:(<span class="built_in">UIColor</span> *)progressColor &#123;</span><br><span class="line">    <span class="keyword">if</span> (!progressColor) &#123;</span><br><span class="line">       <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _progressColor = progressColor;</span><br><span class="line">    <span class="keyword">self</span>.progressColor = progressColor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 不断设置layer描边的结束位置 */</span></span><br><span class="line">- (<span class="keyword">void</span>)progressChanged:(<span class="built_in">NSTimer</span> *)timer &#123;</span><br><span class="line">    <span class="keyword">self</span>.strokeEnd += _stepWidth;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">self</span>.strokeEnd &gt; <span class="number">0.9</span>) &#123;</span><br><span class="line">          _stepWidth = <span class="number">0.0001</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)progressAnimationStart &#123;</span><br><span class="line">    <span class="keyword">self</span>.hidden = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">if</span> (_timer) &#123;</span><br><span class="line">        [<span class="keyword">self</span> invalidateTimer];</span><br><span class="line">    &#125;</span><br><span class="line">    _timer = [<span class="built_in">NSTimer</span> scheduledTimerWithTimeInterval:progressInterval target:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(progressChanged:) userInfo:<span class="literal">nil</span> repeats:<span class="literal">YES</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)progressAnimationCompletion &#123;</span><br><span class="line">    [<span class="keyword">self</span> invalidateTimer];</span><br><span class="line">    <span class="keyword">self</span>.strokeEnd = <span class="number">1.0</span>;</span><br><span class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="number">0.25</span> * <span class="built_in">NSEC_PER_SEC</span>)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">        <span class="keyword">self</span>.hidden = <span class="literal">YES</span>;</span><br><span class="line">        _stepWidth = <span class="number">0.01</span>;</span><br><span class="line">        <span class="keyword">self</span>.strokeEnd = <span class="number">0</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)invalidateTimer &#123;</span><br><span class="line">    [_timer invalidate];</span><br><span class="line">    _timer = <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>好吧，效果来了：<img src="http://upload-images.jianshu.io/upload_images/1890873-e45931be0265dd9b.gif?imageMogr2/auto-orient/strip" alt="图片3"><br>So easy too Happy，拿给产品去看……</p>
<blockquote>
<p>产品：这也太low了吧<br>猿：握草，微信的效果就是这样好不好，丝般顺滑。<br>产品：不行，太大众化了，改成一边加载一边渐变的，前边加载，后边渐隐的<br>猿：尼玛……那不就是QQ的加载效果么，那就不low了吗？<br>产品：我就要那样的效果，你就告诉我能不能做？<br>猿：你大爷……</p>
</blockquote>
<h4 id="3、第三次尝试"><a href="#3、第三次尝试" class="headerlink" title="3、第三次尝试"></a>3、第三次尝试</h4><p>继续百度、Google，并没有发现很好的思路，快要绝望的时候发现CAShapeLayer有一个子类CAGradientLayer<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/* The array <span class="keyword">of</span> CGColorRef objects defining the color <span class="keyword">of</span> <span class="keyword">each</span> gradient</span><br><span class="line"> * <span class="keyword">stop</span>. Defaults <span class="keyword">to</span> nil. Animatable. */</span><br><span class="line"></span><br><span class="line">@<span class="keyword">property</span>(nullable, copy) NSArray *colors;</span><br><span class="line"></span><br><span class="line">/* An <span class="keyword">optional</span> array <span class="keyword">of</span> NSNumber objects defining the location <span class="keyword">of</span> <span class="keyword">each</span></span><br><span class="line"> * gradient <span class="keyword">stop</span> <span class="keyword">as</span> a value <span class="keyword">in</span> the range [<span class="number">0</span>,<span class="number">1</span>]. The values must be</span><br><span class="line"> * monotonically increasing. <span class="keyword">If</span> a nil array <span class="keyword">is</span> given, the stops are</span><br><span class="line"> * assumed <span class="keyword">to</span> spread uniformly across the [<span class="number">0</span>,<span class="number">1</span>] range. <span class="keyword">When</span> rendered,</span><br><span class="line"> * the colors are mapped <span class="keyword">to</span> the output colorspace before being</span><br><span class="line"> * interpolated. Defaults <span class="keyword">to</span> nil. Animatable. */</span><br><span class="line"></span><br><span class="line">@<span class="keyword">property</span>(nullable, copy) NSArray&lt;NSNumber *&gt; *locations;</span><br><span class="line"></span><br><span class="line">/* The start <span class="keyword">and</span> <span class="keyword">end</span> points <span class="keyword">of</span> the gradient <span class="keyword">when</span> drawn <span class="keyword">into</span> the layer<span class="comment">'s</span></span><br><span class="line"> * coordinate space. The start point corresponds <span class="keyword">to</span> the first gradient</span><br><span class="line"> * <span class="keyword">stop</span>, the <span class="keyword">end</span> point <span class="keyword">to</span> the last gradient <span class="keyword">stop</span>. Both points are</span><br><span class="line"> * defined <span class="keyword">in</span> a unit coordinate space that <span class="keyword">is</span> <span class="keyword">then</span> mapped <span class="keyword">to</span> the</span><br><span class="line"> * layer<span class="comment">'s bounds rectangle when drawn. (I.e. [0,0] is the bottom-left</span></span><br><span class="line"> * corner <span class="keyword">of</span> the layer, [<span class="number">1</span>,<span class="number">1</span>] <span class="keyword">is</span> the top-right corner.) The <span class="keyword">default</span> values</span><br><span class="line"> * are [<span class="number">.5</span>,<span class="number">0</span>] <span class="keyword">and</span> [<span class="number">.5</span>,<span class="number">1</span>] respectively. Both are animatable. */</span><br><span class="line"></span><br><span class="line">@<span class="keyword">property</span> CGPoint startPoint;</span><br><span class="line">@<span class="keyword">property</span> CGPoint endPoint;</span><br></pre></td></tr></table></figure></p>
<p>看注释，貌似能设置起始点、终点，还能设置多种颜色，还能设置颜色的位置，我凑，这不就能满足产品🐶的需求了吗？ 快试试……此处省略过程，直接贴代码了<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setProgressStyle:(DKProgressStyle)progressStyle &#123;</span><br><span class="line">    _progressStyle = progressStyle;</span><br><span class="line">    <span class="keyword">if</span> (progressStyle == DKProgressStyle_Gradual) &#123;</span><br><span class="line">        <span class="keyword">self</span>.strokeColor = <span class="literal">nil</span>;</span><br><span class="line">        <span class="built_in">CAGradientLayer</span> *gradientLayer = [<span class="built_in">CAGradientLayer</span> layer];</span><br><span class="line">        <span class="built_in">CGFloat</span> RGB[<span class="number">3</span>];</span><br><span class="line">        [<span class="keyword">self</span> getRGBComponents:RGB forColor:_progressColor];</span><br><span class="line">        gradientLayer.colors = @[(__bridge <span class="keyword">id</span>)[<span class="built_in">UIColor</span> colorWithRed:RGB[<span class="number">0</span>] green:RGB[<span class="number">1</span>] blue:RGB[<span class="number">2</span>] alpha:<span class="number">0.2</span>].CGColor, (__bridge <span class="keyword">id</span>)_progressColor.CGColor];</span><br><span class="line">        gradientLayer.locations = @[@(<span class="number">0</span>), @(<span class="number">0</span>)];</span><br><span class="line">        gradientLayer.startPoint = <span class="built_in">CGPointMake</span>(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        gradientLayer.endPoint = <span class="built_in">CGPointMake</span>(<span class="number">1.0</span>, <span class="number">0</span>);</span><br><span class="line">        gradientLayer.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">        _gradientLayer = gradientLayer;</span><br><span class="line">        [<span class="keyword">self</span> addSublayer:gradientLayer];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">- (<span class="keyword">void</span>)progressChanged:(<span class="built_in">NSTimer</span> *)timer &#123;</span><br><span class="line">    <span class="keyword">self</span>.strokeEnd += _stepWidth;</span><br><span class="line">    <span class="comment">/* 超过90% 减缓进度条增长速度 */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>.strokeEnd &gt; <span class="number">0.9</span>) &#123;</span><br><span class="line">        _stepWidth = <span class="number">0.0001</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (_progressStyle == DKProgressStyle_Gradual) &#123;</span><br><span class="line">        <span class="comment">/* 不断改变layer颜色的起始位置 */</span></span><br><span class="line">        _gradientLayer.locations = @[@(<span class="keyword">self</span>.strokeEnd/<span class="number">2</span>), @(<span class="keyword">self</span>.strokeEnd)];</span><br><span class="line">        <span class="comment">/* 不断改变layer的frame */</span></span><br><span class="line">        _gradientLayer.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, DEVICE_WIDTH*<span class="keyword">self</span>.strokeEnd, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 获取颜色的RGB值 */</span></span><br><span class="line">- (<span class="keyword">void</span>)getRGBComponents:(<span class="built_in">CGFloat</span> [<span class="number">3</span>])components forColor:(<span class="built_in">UIColor</span> *)color &#123;</span><br><span class="line">    <span class="keyword">if</span> (!color) &#123;</span><br><span class="line">        components[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">        components[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">        components[<span class="number">2</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">CGColorSpaceRef</span> rgbColorSpace = <span class="built_in">CGColorSpaceCreateDeviceRGB</span>();</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> resultingPixel[<span class="number">4</span>];</span><br><span class="line">    <span class="built_in">CGContextRef</span> context = <span class="built_in">CGBitmapContextCreate</span>(&amp;resultingPixel, <span class="number">1</span>, <span class="number">1</span>, <span class="number">8</span>, <span class="number">4</span>, rgbColorSpace, kCGImageAlphaNoneSkipLast);</span><br><span class="line">    <span class="built_in">CGContextSetFillColorWithColor</span>(context, [color <span class="built_in">CGColor</span>]);</span><br><span class="line">    <span class="built_in">CGContextFillRect</span>(context, <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>));</span><br><span class="line">    <span class="built_in">CGContextRelease</span>(context);</span><br><span class="line">    <span class="built_in">CGColorSpaceRelease</span>(rgbColorSpace);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> component = <span class="number">0</span>; component &lt; <span class="number">3</span>; component++) &#123;</span><br><span class="line">        components[component] = resultingPixel[component] / <span class="number">255.0</span>f;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>效果如下：<img src="http://upload-images.jianshu.io/upload_images/1890873-8a38ca6ae4a898fb.gif?imageMogr2/auto-orient/strip" alt="图片"></p>
<blockquote>
<p>产品：这么简单的一个东西，你弄这么久，先这么着吧，有什么想法再找你<br>猿：我日尼玛，傻吊……</p>
</blockquote>
<p>好吧，这个需求就暂时告一段落了，产品需求来了再改吧😂</p>
<p><a href="https://github.com/jindk/WebViewProgress" target="_blank" rel="noopener">本文github链接</a>，如果你觉得能帮到你，路过给个Star哈。</p>
<p>######参考链接：<br><a href="http://www.jianshu.com/p/b32b9fb6cb0a" target="_blank" rel="noopener">http://www.jianshu.com/p/b32b9fb6cb0a</a>  感谢作者的思路</p>
</div><div class="tags"><a href="/tags/iOS/">iOS</a></div><div class="post-nav"><a class="pre" href="/2017/11/14/SDWebImage源码浅析/">SDWebImage源码浅析</a><a class="next" href="/2016/04/11/iOS 文本高度计算/">iOS 文本高度计算</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'http://yoursite.com/2017/03/17/UIWebView的加载进度条/';
    this.page.identifier = '2017/03/17/UIWebView的加载进度条/';
    this.page.title = 'UIWebView的加载进度条';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//https-dengkej-github-io.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//https-dengkej-github-io.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://https-dengkej-github-io.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/iOS/" style="font-size: 15px;">iOS</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/11/14/SDWebImage源码浅析/">SDWebImage源码浅析</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/17/UIWebView的加载进度条/">UIWebView的加载进度条</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/04/11/iOS 文本高度计算/">iOS 文本高度计算</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//https-dengkej-github-io.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/DengkeJ" title="Github" target="_blank">Github</a><ul></ul><a href="http://boaihome.com" title="博爱1616的博客" target="_blank">博爱1616的博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">夜满西楼的博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>